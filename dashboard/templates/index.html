<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>E-Paper Dashboard</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <h1>E-Paper Dashboard</h1>
    <form id="layout-form" action="/set_layout" method="post">
        <button type="button" data-layout="weather">Weather Layout</button>
        <button type="button" data-layout="clock">Clock Layout</button>
    </form>

    <script>
        document.querySelectorAll('#layout-form button').forEach(button => {
            button.addEventListener('click', () => {
                const layout = button.dataset.layout;
        
                fetch('/set_layout', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `layout=${layout}`
                }).then(res => console.log(`Layout set to ${layout}`))
                  .catch(err => console.error(err));
            });
        });
    </script>

<!-- Your existing form and canvas -->
<form id="image-form" action="/display_image" method="post" enctype="multipart/form-data">
    <input type="file" name="image" id="image-input" style="display:none" required>
    <input type="hidden" name="threshold" id="threshold-input">
    <button type="button" id="upload-button">Choose Image</button>
    <button type="submit">Submit Image</button>
</form>

<label for="image-slider">Image threshold:</label>
<input type="range" id="image-slider" min="0" max="255" value="128">

<canvas id="image-preview" style="max-width:400px;display:none;margin-top:10px;"></canvas>
<!-- New threshold gradient canvas -->
<canvas id="threshold-preview" width="256" height="20" style="border:1px solid #000; display:block; margin-top:5px;"></canvas>

<script>
const fileInput = document.getElementById("image-input");
const canvas = document.getElementById("image-preview");
const ctx = canvas.getContext("2d");
const slider = document.getElementById("image-slider");
const thresholdInput = document.getElementById("threshold-input");
const thresholdPreview = document.getElementById("threshold-preview");
const thresholdCtx = thresholdPreview.getContext("2d");
let imgElement = new Image();
let imgData = null;

// Your existing upload button
document.getElementById("upload-button").addEventListener("click", () => fileInput.click());

fileInput.addEventListener("change", () => {
    const file = fileInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => { imgElement.src = e.target.result; };
    reader.readAsDataURL(file);
});

imgElement.onload = () => {
    canvas.style.display = "block";
    canvas.width = 800;
    canvas.height = 480;
    ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);
    imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    renderPreview();
};

// 8x8 Bayer matrix for dithering
const bayer8x8 = [
    [0,32,8,40,2,34,10,42],
    [48,16,56,24,50,18,58,26],
    [12,44,4,36,14,46,6,38],
    [60,28,52,20,62,30,54,22],
    [3,35,11,43,1,33,9,41],
    [51,19,59,27,49,17,57,25],
    [15,47,7,39,13,45,5,37],
    [63,31,55,23,61,29,53,21]
];

function getThreshold(x, y, level) {
    return (bayer8x8[y % 8][x % 8] / 63) * level;
}

// Render your image preview with dithering
function renderPreview() {
    if (!imgData) return;
    const data = new Uint8ClampedArray(imgData.data);
    const level = parseInt(slider.value);
    for (let y = 0; y < canvas.height; y++) {
        for (let x = 0; x < canvas.width; x++) {
            const i = (y * canvas.width + x) * 4;
            const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
            const threshold = getThreshold(x, y, level);
            const bw = gray < threshold ? 0 : 255;
            data[i] = data[i+1] = data[i+2] = bw;
            data[i+3] = 255;
        }
    }
    ctx.putImageData(new ImageData(data, canvas.width, canvas.height), 0, 0);
}

// Render a horizontal gradient for the threshold visualization
function renderThresholdGradient() {
    const width = thresholdPreview.width;
    const height = thresholdPreview.height;
    const imgData = thresholdCtx.createImageData(width, height);

    for (let y=0; y<height; y++) {
        for (let x=0; x<width; x++) {
            const i = (y*width + x)*4;
            const level = (x / (width-1)) * 255;
            const m = bayer8x8[y % 8][x % 8];
            const threshold = (m / 63) * level;
            const value = threshold < level ? 0 : 255;
            imgData.data[i] = imgData.data[i+1] = imgData.data[i+2] = value;
            imgData.data[i+3] = 255;
        }
    }

    thresholdCtx.putImageData(imgData, 0, 0);
}

// Update both image preview and gradient as slider changes
slider.addEventListener("input", () => {
    thresholdInput.value = slider.value;
    renderPreview();
    renderThresholdGradient();
});

// Initial render of gradient
renderThresholdGradient();
</script>



</body>
</html>
