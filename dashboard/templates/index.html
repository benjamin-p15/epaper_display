<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>E-Paper Dashboard</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <h1>E-Paper Dashboard</h1>
    <form id="layout-form" action="/set_layout" method="post">
        <button type="button" data-layout="weather">Weather Layout</button>
        <button type="button" data-layout="clock">Clock Layout</button>
    </form>

    <script>
        document.querySelectorAll('#layout-form button').forEach(button => {
            button.addEventListener('click', () => {
                const layout = button.dataset.layout;
        
                fetch('/set_layout', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `layout=${layout}`
                }).then(res => console.log(`Layout set to ${layout}`))
                  .catch(err => console.error(err));
            });
        });
    </script>

<form id="image-form" action="/display_image" method="post" enctype="multipart/form-data">
    <input type="file" name="image" id="image-input" style="display:none" required>
    <input type="hidden" name="threshold" id="threshold-input">
    <button type="button" id="upload-button">Choose Image</button>
    <button type="submit">Submit Image</button>
</form>

<label for="image-slider">Image threshold:</label>
<input type="range" id="image-slider" min="0" max="255" value="128">
<canvas id="threshold-preview" width="256" height="20" style="border:1px solid #000; display:block; margin-top:5px;"></canvas>

<script>
// Bayer 8x8 matrix
const bayer8x8 = [
  [0,32,8,40,2,34,10,42],
  [48,16,56,24,50,18,58,26],
  [12,44,4,36,14,46,6,38],
  [60,28,52,20,62,30,54,22],
  [3,35,11,43,1,33,9,41],
  [51,19,59,27,49,17,57,25],
  [15,47,7,39,13,45,5,37],
  [63,31,55,23,61,29,53,21]
];

const slider = document.getElementById("image-slider");
const previewCanvas = document.getElementById("threshold-preview");
const previewCtx = previewCanvas.getContext("2d");

function renderThresholdPreview() {
    const width = previewCanvas.width;
    const height = previewCanvas.height;
    const imgData = previewCtx.createImageData(width, height);
    
    for(let y=0; y<height; y++){
        for(let x=0; x<width; x++){
            const i = (y*width + x)*4;
            const level = x; // use x-position as threshold value (0-255)
            const m = bayer8x8[y % 8][x % 8];
            const threshold = (m/63)*level;
            const value = threshold < level ? 0 : 255; // black/white dithering
            imgData.data[i] = imgData.data[i+1] = imgData.data[i+2] = value;
            imgData.data[i+3] = 255;
        }
    }
    previewCtx.putImageData(imgData, 0, 0);
}

// Update preview live when slider moves
slider.addEventListener("input", renderThresholdPreview);
renderThresholdPreview();
</script>



</body>
</html>
