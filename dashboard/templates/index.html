<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>E-Paper Dashboard</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <h1>E-Paper Dashboard</h1>
    <form id="layout-form" action="/set_layout" method="post">
        <button type="button" data-layout="weather">Weather Layout</button>
        <button type="button" data-layout="clock">Clock Layout</button>
    </form>

    <script>
        document.querySelectorAll('#layout-form button').forEach(button => {
            button.addEventListener('click', () => {
                const layout = button.dataset.layout;
        
                fetch('/set_layout', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `layout=${layout}`
                }).then(res => console.log(`Layout set to ${layout}`))
                  .catch(err => console.error(err));
            });
        });
    </script>

    <form id="image-form" action="/display_image" method="post" enctype="multipart/form-data">
        <input type="file" name="image" id="image-input" style="display:none" required>
        <button type="button" id="upload-button">Choose Image</button>
        <button type="submit">Submit Image</button>
    </form>   

    <label for="image-slider">Threshold:</label>
    <input type="range" id="image-slider" min="0" max="255" value="128">

    <canvas id="image-preview" style="max-width: 400px; display:none; margin-top: 10px;"></canvas>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const uploadButton = document.getElementById('upload-button');
            const fileInput = document.getElementById('image-input');
            const slider = document.getElementById('image-slider');
            const canvas = document.getElementById('image-preview');
            const ctx = canvas.getContext('2d');
            let imgElement = new Image();
        
            // Open file picker
            uploadButton.addEventListener('click', () => fileInput.click());
        
            // Load selected image
            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        imgElement.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        
            // Draw image with threshold effect
            function drawPreview(threshold) {
                canvas.width = imgElement.width;
                canvas.height = imgElement.height;
                ctx.drawImage(imgElement, 0, 0);
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                let data = imageData.data;
        
                for (let i = 0; i < data.length; i += 4) {
                    // Convert to grayscale
                    let gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                    // Apply threshold mapping similar to e-paper display
                    let value = gray < threshold ? 0 : 255;
                    data[i] = data[i + 1] = data[i + 2] = value;
                }
        
                ctx.putImageData(imageData, 0, 0);
                canvas.style.display = "block";
            }
        
            // Redraw when slider changes
            slider.addEventListener('input', () => drawPreview(slider.value));
        
            // Draw once image is loaded
            imgElement.onload = () => drawPreview(slider.value);
        });
        </script>
</body>
</html>
